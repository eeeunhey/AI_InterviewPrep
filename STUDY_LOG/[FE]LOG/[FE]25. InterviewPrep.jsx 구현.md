// React 코어 훅 불러오기
import React, { useEffect, useState } from "react";
// URL 파라미터(예: /session/:sessionId) 접근을 위한 훅
import { useParams } from "react-router-dom";
// 날짜 포맷팅 유틸
import moment from "moment";
// Framer Motion: 진입/퇴장/레이아웃 애니메이션
import { AnimatePresence, motion } from "framer-motion";
// 아이콘들
import { LuCircleAlert, LuListCollapse } from "react-icons/lu";
// 로딩 스피너 컴포넌트
import SpinnerLoader from "../../component/Loader/SpinnerLoader";
// 토스트 알림
import { toast } from "react-hot-toast";
// 페이지 상단/좌측 레이아웃 래퍼
import DashboardLayout from "../../component/layout/DashboardLayout";
// 역할/설명 등 요약 헤더
import RoleInfoHeader from "./components/RoleInfoHeader";
// 공용 Axios 인스턴스(토큰/베이스URL/인터셉터 설정됨)
import axiosInstance from "../../utils/axiosInstance";
// API 엔드포인트 경로 모음
import { API_PATHS } from "../../utils/apiPaths";
// moment 한국어 로케일
import "moment/locale/ko";

// (필요) 질문 카드를 렌더링하는 컴포넌트
// import QuestionCard from "../../component/Cards/QuestionCard";

const InterviewPrep = () => {
  // URL의 :sessionId 파라미터 추출
  const { sessionId } = useParams();

  // 세션 상세 데이터(역할/질문 목록/설명 등)
  const [sessionData, setSessionData] = useState(null);
  // 에러 메시지(표시용)
  const [errorMsg, setErrorMsg] = useState("");

  // 우측 ‘더 알아보기’ 드로어 열림 상태
  const [openLeanMoreDrawer, setOpenLeanMoreDrawer] = useState(false);
  // 질문에 대한 개념/배경 설명 텍스트 상태
  const [explanation, setExplanation] = useState(null);

  // 페이지 최초 데이터 로딩 상태
  const [isLoading, setIsLoading] = useState(false);
  // 핀 토글/질문 추가 등 업데이트 중 로딩 상태
  const [isUpdateLoader, setIsUpdateLoader] = useState(false);

  // 세션 ID로 데이터 가져오기
  const fetchSessionDatailsById = async () => {
    try {
      // /sessions/:id 같은 형태로 단건 조회
      const response = await axiosInstance.get(
        API_PATHS.SESSION.GET_ONE(sessionId)
      );

      // API 스키마: { session: {...} } 형태라고 가정
      if (response.data && response.data.session) {
        setSessionData(response.data.session);
      }
    } catch (error) {
      // 네트워크/서버 에러 로깅
      console.error("Error:", error);
      // 사용자 노출용 에러 상태도 세팅 가능
      setErrorMsg("세션을 불러오지 못했습니다.");
      // toast.error("세션을 불러오지 못했습니다."); // 필요 시
    }
  };

  // 사용자가 “더 알아보기”를 눌렀을 때 질문에 대한 설명 생성(LLM 호출 등)
  const generateConceptExplanation = async (question) => {
    // TODO: 백엔드 호출 로직 작성
    // setIsUpdateLoader(true);
    // const { data } = await axiosInstance.post(API_PATHS.EXPLAIN, { question });
    // setExplanation(data.explanation);
    // setOpenLeanMoreDrawer(true);
    // setIsUpdateLoader(false);
  };

  // 핀 상태 토글(중요한 질문 상단 고정)
  const toggleQuestionPinStatus = async (questionId) => {
    // TODO: 서버에 핀 토글 요청 → 성공 시 sessionData 갱신
    // setIsUpdateLoader(true);
    // await axiosInstance.patch(API_PATHS.QUESTION.TOGGLE_PIN(questionId));
    // await fetchSessionDatailsById(); // 또는 낙관적 업데이트
    // setIsUpdateLoader(false);
  };

  // “질문 더 불러오기” 기능: 이미 존재하는 세션에 질문 추가
  const uploadMoreQuestions = async () => {
    // TODO: 서버에 추가 생성 요청 → 결과를 sessionData.questions에 병합
    // setIsUpdateLoader(true);
    // const { data } = await axiosInstance.post(API_PATHS.SESSION.MORE_Q(sessionId));
    // setSessionData(prev => ({ ...prev, questions: [...prev.questions, ...data.questions] }));
    // setIsUpdateLoader(false);
  };

  // 마운트 시(또는 sessionId 변동 시) 세션 로딩
  useEffect(() => {
    if (sessionId) {
      fetchSessionDatailsById();
    }
    // 클린업은 현재 필요 없음
    return () => {};
    // ⚠️ sessionId가 바뀌면 다시 호출되도록 의존성에 sessionId를 넣는 편이 안전
  }, []); // <- [sessionId]를 권장

  // 화면 렌더링 시작
  return (
    // 전체 페이지 레이아웃 래퍼(헤더/사이드바 등 포함)
    <DashboardLayout>
      {/* 상단 역할/토픽/경력/질문수/설명/최근 업데이트일 요약 표시 */}
      <RoleInfoHeader
        role={sessionData?.role || ""}
        topicsToFocus={sessionData?.topicsToFocus || ""}
        experience={sessionData?.experience || "-"}
        questions={sessionData?.questions?.length || "-"}
        description={sessionData?.description || ""}
        // updatedAt이 있으면 한국어 포맷으로 표시
        lastUpdated={
          sessionData?.updatedAt
            ? moment(sessionData.updatedAt)
                .locale("ko")
                .format("YYYY년 M월 D일")
            : ""
        }
      />

      {/* 메인 컨테이너: 가운데 정렬 + 상하 여백 + 반응형 좌우 패딩 */}
      <div className="container mx-auto pt-4 pb-4 px-4 md:px-0">
        {/* 섹션 제목 */}
        <h2 className="text-lg font-semibold color-black">Interview Q & A</h2>

        {/* 12컬럼 그리드: 본문/사이드 드로어 구성 */}
        <div className="grid grid-cols-12 gap-4 mt-5 mb-10">
          {/* 본문 영역: 드로어가 열리면 7, 닫히면 8 컬럼 차지 */}
          <div
            className={`col-span-12 ${
              openLeanMoreDrawer ? "md:col-span-7" : "md:col-span-8"
            }`}
          >
            {/* 리스트 아이템 진입/퇴장 애니메이션 핸들링 */}
            <AnimatePresence initial={false} mode="popLayout">
              {/* 질문 목록을 순회하여 카드 렌더링 */}
              {sessionData?.questions?.map((data, index) => (
                // 각 질문 블록 컨테이너(애니메이션 래퍼)
                <motion.div
                  key={data?._id ?? index}              // React/Framer가 아이템 식별
                  initial={{ opacity: 0, y: -20 }}      // 첫 진입 시 위에서 살짝 슬라이드
                  animate={{ opacity: 1, y: 0 }}        // 표시 상태
                  exit={{ opacity: 0, scale: 0.95 }}    // 제거 시 살짝 축소/페이드
                  layout                                    // 레이아웃 변화(정렬/핀) 애니메이션
                  layoutId={`question-${data?._id ?? index}`} // 공유 레이아웃 전환이 필요할 때 사용
                  transition={{
                    type: "spring",                     // 스프링 기반 자연스러운 움직임
                    stiffness: 100,                     // 스프링 강성(값↑ → 더 단단)
                    damping: 15,                        // 감쇠(값↑ → 덜 출렁)
                    delay: index * 0.1,                 // 리스트 아이템 순차 등장
                  }}
                  className="mb-3"                      // 카드 간 간격
                >
                  {/* 개별 질문/답변 카드 */}
                  <QuestionCard
                    question={data?.question}           // 질문 텍스트
                    answer={data?.answer}               // 답변 텍스트(요약/모범답 등)
                    isPinned={data?.isPinned}           // 상단 고정 여부
                    openLearnMore={() =>                // 더 알아보기 클릭 시
                      generateConceptExplanation(data?.question)
                    }
                    onTogglePin={() =>                  // 핀 토글 클릭 시
                      toggleQuestionPinStatus(data?._id ?? index)
                    }
                  />
                </motion.div>
              ))}
            </AnimatePresence>
          </div>

          {/* 우측 드로어 영역(예: 설명 패널) - 필요 시 별도 div로 col-span-4/5 배치 */}
          {/* {openLeanMoreDrawer && (
            <aside className="hidden md:block md:col-span-5">
              ...설명/요약/키워드 등...
            </aside>
          )} */}
        </div>
      </div>
    </DashboardLayout>
  );
};

// (참고) 실제 구현 파일 경로 주석
// 구현 완료 -> frontend/Cards/QuestionCard.jsx

export default InterviewPrep;


layoutId

문자열(고유 ID)을 주면:
A 컴포넌트에서 B 컴포넌트로 “자리 바꿔치기”를 할 때 애니메이션으로 연결 해줍니다.
→ 예: 리스트에 있던 카드가 모달로 확대되는 전환 같은 경우.

AIResposePreivew.jsx를 구현하고 이제
ToggleQuestionPinStatus 를 지정한다 

