server.js 
app.use("/api/ai/generate-questions", protect, generateInterviewQuestions);
app.use("/api/ai/generate-explanation", protect, generateConceptExplanation);
추가한다

라우터를 설정하지 않고 바로 컨트롤러를 수정한다

controllers/aiControllers.js를 수정
제미나이 API키를 이용한다

 **Google Gemini API**를 이용해서 **면접 질문/답변 생성**과 **질문 개념 설명**을 만드는 API 서버 코드

---

## 1. 상단 모듈 가져오기

```js
const { GoogleGenerativeAI } = require("@google/generative-ai");
const { concepExplainPrompt, questionAnswerPrompt } = require("../utils/prompts");
```

* **GoogleGenerativeAI** : 구글 Gemini API를 쓰기 위한 라이브러리.
* **prompts.js** : 프롬프트(명령 텍스트)를 만드는 함수들을 따로 정리한 파일.

  * `questionAnswerPrompt` → 질문/답변 생성용 프롬프트
  * `concepExplainPrompt` → 개념 설명용 프롬프트

---

## 2. Gemini API 연결

```js
const ai = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const model = ai.getGenerativeModel({ model: "gemini-pro" });
```

* **process.env.GEMINI\_API\_KEY** : `.env` 파일에 저장된 Gemini API Key를 불러옴.
* **gemini-pro** : 기본 모델을 불러오기 위해 지정.
* 이후 `ai.model.generateContent({...})`를 통해 텍스트 생성 가능.

---

## 3. 면접 질문 생성 API

```js
const generateInterviewQuestions = async (req, res) => {
    try {
        const { role, experience, topicToFocus, numberOfQuestions } = req.body;

        if (!role || !experience || !topicsToFocus || !numberOfQuestions) {
            return res.status(400).json({ message: "필수 입력 항목이 누락되었습니다"});
        }

        const prompt = questionAnswerPrompt(role, experience, topicToFocus, numberOfQuestions);

        const response = await ai.model.generateContent({
            model: "Gemini-2.5-Flash-Lite",
            contents: prompt,
        });

        let rawText = response.text;
```

* **req.body** : 클라이언트가 보낸 JSON 데이터

  * `role` (지원 직무)
  * `experience` (경력 수준)
  * `topicToFocus` (집중할 주제)
  * `numberOfQuestions` (질문 개수)

* 입력값이 하나라도 빠지면 → 400 에러 반환

* **questionAnswerPrompt(...)** : 전달받은 정보로 Gemini에 보낼 프롬프트 작성

* **ai.model.generateContent(...)** : Gemini 모델에게 프롬프트를 보내고 결과를 받음

---

## 4. JSON 응답 정리

````js
        const cleanedText = rawText
            .replace(/^```json\s*/, "") // 시작 부분의 ```json 제거
            .replace(/```$/, "")        // 끝 부분의 ``` 제거
            .trim();                    // 앞뒤 공백 제거

        const data = JSON.parse(cleanedText);

        res.status(200).json(data);
````

* Gemini가 JSON을 코드 블록(`json ... `) 안에 줄 수도 있음 → 이걸 제거해야 **JSON.parse** 가능
* `cleanedText` → 안전하게 가공된 문자열
* `JSON.parse` → 실제 자바스크립트 객체로 변환
* 최종적으로 `res.status(200).json(data)` → 클라이언트에 결과 반환

---

## 5. 개념 설명 API

```js
const generateConceptExplanation = async (req, res) => {
    try {
        const { question } = req.body;

        if(!question) {
            return res.status(400).json({ message: "필수 입력 항목이 누락되었습니다" })
        }

        const prompt = concepExplainPrompt(question);

        const response = await ai.model.generateContent({
            model: "Gemini-2.5-Flash-Lite",
            contents: prompt,
        });
```

* 클라이언트가 보낸 \*\*질문(question)\*\*을 받아옴
* `concepExplainPrompt(question)` → Gemini에 보낼 프롬프트 작성
* `generateContent(...)` → Gemini에게 설명을 생성하도록 요청

````js
        let rawText = response.text;

        const cleanedText = rawText
            .replace(/^```json\s*/, "") 
            .replace(/```$/, "")        
            .trim();                   

        const data = JSON.parse(cleanedText);

        res.status(200).json(data);
````

* 질문 설명도 마찬가지로 JSON 코드 블록을 제거하고, 파싱 후 결과 반환

---

## 6. 에러 처리

```js
    } catch (error) {
        res.status(500).json({
            message: "질문 생성에 실패하였습니다.",
            error: error.message,
        });
    }
```
* 문제가 생기면(프롬프트 오류, JSON 파싱 오류, API 오류 등) → 500번 서버 에러 반환

---

## 7. 모듈 내보내기

```js
module.exports = { generateInterviewQuestions, generateConceptExplanation };
```
* 이 두 함수를 외부에서 import해서 Express 라우터에 연결 가능

---

✅ **정리**
이 코드는 Express 서버에서

1. `/api/ai/generate-questions` → 면접 질문/답변 생성
2. `/api/ai/generate-explanation` → 질문 개념 설명
을 처리하는 **백엔드 AI API**입니다.


